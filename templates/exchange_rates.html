{% extends "base.html" %}

{% block title %}Exchange Rates - ECB Financial Data Visualizer{% endblock %}
{% block page_title %}EUR/USD Exchange Rates{% endblock %}

{% block page_actions %}
<button class="btn btn-sm btn-primary me-2" onclick="refreshData()">
    <i class="fas fa-sync-alt me-1"></i>
    Refresh
</button>
<button class="btn btn-sm btn-outline-secondary me-3" onclick="exportData()">
    <i class="fas fa-download me-1"></i>
    Export
</button>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
<li class="breadcrumb-item active">Exchange Rates</li>
{% endblock %}

{% block content %}
<!-- Key Metrics -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="text-muted mb-2">Current Rate</h6>
                    <h3 class="text-primary mb-0" id="currentRate">Loading...</h3>
                    <small class="text-muted">EUR per USD</small>
                </div>
                <div class="text-primary">
                    <i class="fas fa-euro-sign fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="text-muted mb-2">24h Change</h6>
                    <h3 class="mb-0" id="dailyChange">Loading...</h3>
                    <small class="text-muted">Percentage change</small>
                </div>
                <div class="text-info">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="text-muted mb-2">Data Points</h6>
                    <h3 class="text-success mb-0" id="dataPoints">Loading...</h3>
                    <small class="text-muted">Available observations</small>
                </div>
                <div class="text-success">
                    <i class="fas fa-database fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="text-muted mb-2">Last Updated</h6>
                    <h3 class="text-warning mb-0" id="lastUpdated">Loading...</h3>
                    <small class="text-muted">Data timestamp</small>
                </div>
                <div class="text-warning">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="fas fa-chart-area me-2"></i>
                    EUR/USD Exchange Rate Chart
                </h5>
                <div></div>
            </div>
            <div id="exchangeRateChart" style="width: 100%; position: relative;"></div>
        </div>
    </div>
</div>

<!-- Data Analysis -->
<div class="row g-4">
    <div class="col-lg-6">
    <div class="chart-container" style="overflow: hidden;">
            <div class="chart-header">
                <h6 class="chart-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Market Analysis
                </h6>
            </div>
            <div id="marketAnalysis">
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="mt-2 text-muted">Analyzing market data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <h6 class="chart-title">
                    <i class="fas fa-table me-2"></i>
                    Recent Data Points
                </h6>
            </div>
            <div id="recentData">
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-2 text-muted">Loading recent data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('📈 EUR/USD Exchange Rates Page Loading');

let currentChartData = null;

// Load exchange rate data and chart
async function loadExchangeRateData() {
    try {
    showChartLoading('exchangeRateChart', 'Loading EUR/USD exchange rate data...');
        
        const response = await fetch('/api/exchange-rates');
        const data = await response.json();
        
        if (!data.success) {
            document.getElementById('exchangeRateChart').innerHTML = 
                `<div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'No exchange rate data available'}
                    <br><small class="text-muted">${data.message || 'Try refreshing the data'}</small>
                </div>`;
            return;
        }
        
        // Store chart data for time range filtering
        currentChartData = data;
        
    // Clear loading indicator before rendering
    const chartEl = document.getElementById('exchangeRateChart');
    if (chartEl) chartEl.innerHTML = '';

        // Render with dashboard-like sizing (matches interest chart behavior)
        await Plotly.newPlot(chartEl, data.chart.data, {
            ...data.chart.layout,
            showlegend: false,
            title: '',
            autosize: true,
            height: 300,
            margin: { l: 50, r: 40, t: 20, b: 40 }
        }, {
            responsive: true,
            displayModeBar: true,
            scrollZoom: true,
            doubleClick: 'reset'
        });

    // Ensure chart resizes to container (handle delayed layout changes)
    try { if (chartEl) Plotly.Plots.resize(chartEl); } catch (_) {}
    setTimeout(() => { try { if (chartEl) Plotly.Plots.resize(chartEl); } catch (_) {} }, 100);
    setTimeout(() => { try { if (chartEl) Plotly.Plots.resize(chartEl); } catch (_) {} }, 350);
        
        // Update metrics
        updateMetrics(data);
        
        // Update analysis
        updateMarketAnalysis(data);
        updateRecentData(data);
        
        console.log('✅ Exchange rate data loaded successfully');
        
    } catch (error) {
        console.error('Error loading exchange rate data:', error);
    document.getElementById('exchangeRateChart').innerHTML = 
            `<div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading exchange rate data: ${error.message}
            </div>`;
    }
}

// Update key metrics
function updateMetrics(data) {
    // Current rate
    document.getElementById('currentRate').textContent = 
        data.latest_rate ? data.latest_rate.toFixed(4) : 'N/A';
    
    // Calculate daily change from last two observations
    const changeElement = document.getElementById('dailyChange');
    try {
        const ys = data?.chart?.data?.[0]?.y || [];
        if (Array.isArray(ys) && ys.length >= 2) {
            const last = parseFloat(ys[ys.length - 1]);
            const prev = parseFloat(ys[ys.length - 2]);
            if (isFinite(last) && isFinite(prev) && prev !== 0) {
                const pct = ((last - prev) / prev) * 100;
                const sign = pct > 0 ? '+' : '';
                changeElement.textContent = `${sign}${pct.toFixed(2)}%`;
                changeElement.className = `${pct >= 0 ? 'text-success' : 'text-danger'} mb-0`;
            } else {
                changeElement.textContent = 'N/A';
                changeElement.className = 'text-muted mb-0';
            }
        } else {
            changeElement.textContent = 'N/A';
            changeElement.className = 'text-muted mb-0';
        }
    } catch (_) {
        changeElement.textContent = 'N/A';
        changeElement.className = 'text-muted mb-0';
    }
    
    // Data points
    document.getElementById('dataPoints').textContent = data.data_points || '0';
    
    // Last updated
    const lastUpdated = data.last_updated ? 
        new Date(data.last_updated).toLocaleDateString() : 'N/A';
    document.getElementById('lastUpdated').textContent = lastUpdated;
}

// Update market analysis
function updateMarketAnalysis(data) {
    const analysisHtml = `
        <div class="p-3">
            <h6 class="text-primary mb-3">Current Market Status</h6>
            <div class="row g-3">
                <div class="col-6">
                    <div class="border-start border-primary border-3 ps-3">
                        <small class="text-muted">Current Rate</small>
                        <div class="fw-bold">${data.latest_rate?.toFixed(4) || 'N/A'}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="border-start border-success border-3 ps-3">
                        <small class="text-muted">Data Coverage</small>
                        <div class="fw-bold">${data.data_points || 0} points</div>
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <div class="bg-light p-3 rounded">
                        <small class="text-muted">Series Information</small>
                        <div class="fw-bold">${data.series_title || 'EUR/USD Exchange Rate'}</div>
                        <small class="text-muted">${data.unit || 'EUR per USD'}</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('marketAnalysis').innerHTML = analysisHtml;
}

// Update recent data table
function updateRecentData(data) {
    // This would show recent data points in a table format
    const recentDataHtml = `
        <div class="p-3">
            <h6 class="text-success mb-3">Data Summary</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td class="text-muted">Latest Rate</td>
                            <td class="fw-bold">${data.latest_rate?.toFixed(4) || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Total Data Points</td>
                            <td class="fw-bold">${data.data_points || 0}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Data Source</td>
                            <td class="fw-bold">European Central Bank</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Update Frequency</td>
                            <td class="fw-bold">Daily</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Last Refresh</td>
                            <td class="fw-bold">${data.last_updated ? new Date(data.last_updated).toLocaleString() : 'N/A'}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('recentData').innerHTML = recentDataHtml;
}

// Show loading state for charts
function showChartLoading(chartId, message = 'Loading...') {
    const container = document.getElementById(chartId);
    container.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">${message}</span>
            </div>
            <p class="mt-3 text-muted">${message}</p>
        </div>
    `;
}

// Set time range for chart
function setTimeRange(range) {
    if (!currentChartData) return;
    
    // This would filter the chart data based on selected time range
    // For now, we'll just highlight the selected button
    document.querySelectorAll('[onclick*="setTimeRange"]').forEach(btn => {
        btn.className = 'btn btn-sm btn-outline-primary me-2';
    });
    
    event.target.className = 'btn btn-sm btn-primary me-2';
    
    // Here you would implement actual time range filtering
    showAlert(`Time range set to: ${range}`, 'info');
}

// Refresh data
async function refreshData() {
    try {
        showAlert('Refreshing EUR/USD exchange rate data...', 'info');
        
        const refreshResponse = await fetch('/api/refresh/exchange-rates', { method: 'POST' });
        const refreshData = await refreshResponse.json();
        
        if (refreshData.success) {
            showAlert('✅ Exchange rate data refreshed successfully!', 'success');
            
            // Reload data after a brief delay
            setTimeout(() => {
                loadExchangeRateData();
            }, 1000);
        } else {
            showAlert(`❌ Failed to refresh data: ${refreshData.error}`, 'danger');
            // Still try to load existing data
            loadExchangeRateData();
        }
        
    } catch (error) {
        console.error('Refresh failed:', error);
        showAlert(`❌ Refresh failed: ${error.message}`, 'danger');
    }
}

// Export data
function exportData() {
    if (!currentChartData) {
        showAlert('No data available to export', 'warning');
        return;
    }
    
    // This would implement data export functionality
    showAlert('Export functionality coming soon...', 'info');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('📈 Initializing EUR/USD Exchange Rates page...');
    
    // Load exchange rate data
    setTimeout(() => {
        loadExchangeRateData();
    }, 500);
    
    console.log('✅ EUR/USD Exchange Rates page initialization complete');
});

console.log('📈 EUR/USD Exchange Rates Page Loaded');
</script>
{% endblock %}
